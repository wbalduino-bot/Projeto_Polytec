// backend/server.js

const express = require('express');
const cors = require('cors');
const path = require('path');
const sequelize = require('./config/database'); // ConexÃ£o com SQLite via Sequelize





const app = express();



// Middlewares globais
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'frontend', 'public')));

// Sincroniza modelos com o banco SQLite
sequelize.sync({ alter: true })
  .then(() => console.log('âœ… Banco de dados sincronizado com sucesso.'))
  .catch((err) => console.error('âŒ Erro ao sincronizar banco:', err));

// ImportaÃ§Ã£o explÃ­cita de todas as rotas
const produtoRoutes = require('./routes/produtoRoutes');        // Rotas de produtos (CRUD de produtos)
const pedidoRoutes = require('./routes/pedidoRoutes');          // Rotas de pedidos (CRUD de pedidos e gerenciamento de status)
const registrarPagamento = require('./routes/pagamentoRoutes'); // Rota para registrar pagamentos (ex: via boleto, cartÃ£o, etc.)
const boletosRoutes = require('./routes/boletosRoutes');        // Rotas de boletos (emissÃ£o, consulta e cancelamento)
const logRoutes = require('./routes/logRoutes');                // Rotas de logs do sistema (aÃ§Ãµes, erros, auditoria tÃ©cnica)
const authRoutes = require('./routes/authRoutes');              // Rotas de autenticaÃ§Ã£o (login, registro, token)
const usuariosRoutes = require('./routes/usuarios');            // Rotas de gerenciamento de usuÃ¡rios (CRUD de usuÃ¡rios e perfis)
const publicRoutes = require('./routes/publicRoutes');          // Rotas pÃºblicas (acessÃ­veis sem autenticaÃ§Ã£o)
const protectedRoutes = require('./routes/protectedRoutes');    // Rotas protegidas (requerem autenticaÃ§Ã£o e autorizaÃ§Ã£o)
const auditoriaRoutes = require('./routes/auditoriaRoutes');    // Rotas de auditoria (registro de aÃ§Ãµes administrativas e operacionais)
const permissoesRoutes = require('./routes/permissoesRoutes');  // Rotas de permissÃµes (controle de acesso por funÃ§Ã£o ou perfil)
const interacaoRoutes = require('./routes/interacaoRoutes');    // Rotas de interaÃ§Ãµes (CRM: ligaÃ§Ãµes, reuniÃµes, e-mails com clientes)
const oportunidadeRoutes = require('./routes/oportunidadeRoutes'); // CRM: pipeline de vendas e estÃ¡gios de negociaÃ§Ã£o por cliente
const dashboardRoutes = require('./routes/dashboardRoutes');      // Dados agregados para grÃ¡ficos e indicadores
const reembolsoRoutes = require('./routes/reembolsoRoutes'); // Rotas de reembolso

// Registro das rotas
app.use('/produtos', produtoRoutes);       // CRUD de produtos
app.use('/pedidos', pedidoRoutes);         // CRUD de pedidos
app.use('/boletos', boletosRoutes);        // Gerenciamento de boletos
app.use('/logs', logRoutes);               // Logs do sistema
app.use('/auth', authRoutes);              // /auth/login e /auth/register
app.use('/usuarios', usuariosRoutes);      // Gerenciamento de usuÃ¡rios
app.use('/auditoria', auditoriaRoutes);    // Auditoria de aÃ§Ãµes
app.use('/permissoes', permissoesRoutes);  // Controle de permissÃµes
app.use('/', registrarPagamento);          // Registro de pagamentos
app.use('/', publicRoutes);                // Rotas pÃºblicas
app.use('/', protectedRoutes);             // Rotas protegidas
app.use('/interacoes', interacaoRoutes);   // CRM: registro de interaÃ§Ãµes com clientes (ligaÃ§Ãµes, reuniÃµes, e-mails)
app.use('/oportunidades', oportunidadeRoutes); // CRM: pipeline de vendas por cliente
app.use('/dashboard', dashboardRoutes); // Dados agregados para grÃ¡ficos e indicadores
app.use('/reembolsos', reembolsoRoutes); // Rotas de reembolso
// Evite duplicar login se jÃ¡ estiver em authRoutes
// app.post('/auth/login', require('./controllers/authController').login);

// Inicializa servidor
const PORT = 3001;
app.listen(PORT, () => {
  console.log(`ðŸš€ Servidor rodando na porta ${PORT}`);
});


